# 7장: 가비지 수집 고급

### 개요

6장에서는 Hotspot VM의 개요와 런타임 동작 시 일어나는 일들을 알아봤습니다. 이번 장에서는 가비지 수집의 이론에 대해서 알아보겠습니다. Parallel Collector부터 CMS, G1 등 중단 시간이 짧은 가비지 컬렉터를 알아보고 뒤에서는 셰난도아, C4, 밸런스드, 레거시 핫스팟 컬렉터도 알아보겠습니다.

---

### 가비지 컬렉터는 어떻게 선택해야되나요?

- 자바의 가비지 수집기는 탈착형입니다. 즉 자바 구현체 중에는 가비지 수집 기능이 없는 것도 존재합니다. 즉 뺐다 꼈다 할 수 있는 것이죠. 이렇게 만든 이유는 모든 상황에 적합한 가비지 컬렉터는 없기 때문입니다. 따라서 우린 서비스 운용 환경에 맞춰 적절한 가비지 컬렉터를 선택해 사용해야 합니다.
- 우리가 가비지 컬렉터를 선택할 때 고려해야할 수 있는 기준은 아래의 총 5가지입니다. 일반적으로 짧은 중단 시간을 고려하지만 반드시 그런 것은 아닙니다. 예를 들어 고도 병렬 배치 처리 혹은 빅데이터 애플리케이션에서는 작업 중지 시간이 생각보다 크리티컬하지 않습니다. 오히려 CPU 효율 및 처리율이 우수한 GC 알고리즘이 훨씬 우선순위가 높습니다.
    - 중단 시간
        - 주로 많은 관심을 받는 요소입니다. 하지만 경우에 따라 효과적이지 않은 성능 특성이 아닐수도 있다는 것을 인지해야 합니다.
    - 처리율
        - 애플리케이션 런타임에서 GC가 일어나는 시간이 몇 %인가
    - 중단 빈도
        - 가비지 컬렉터로 인해 애플리케이션이 정지하는 횟수가 얼마나 되는가
    - 회수 효율
        - GC 사이클 당 수집되는 가비지가 얼마나 되는가?
    - 중단 일관성
        - 중단 시간이 일정한 편인가?

---

### Concurrent GC 이론

- 일반적으로 가비지 컬렉터는 말 그대로 가비지만 수집하는 것에 온 신경을 쏟습니다. 컬렉터가 어떤 도메인 환경에 처해있는지는 전혀 고려되지 않았기 때문에 도메인에 특화된 가비지 컬렉팅, 즉 **효과적인 중단 시점을 결정하는 것은 매우 어렵습니다**. 또한 메모리 할당은 불확정성을 유발하는 직접적인 원인이기에 최신 가비지 컬렉터의 성능 개선의 관점은 주로 **불확정적인 STW 중단 문제의 해결**입니다.
    - 쉽게 얘기해서 GC를 수행하며 STW가 언제 발생하는지를 예측하고 싶다는 것입니다. 뒤에서 나오겠지만 우리가 알고 있는 STW에서의 쓰레드 정지는 “하나, 둘, 셋!” 하고 멈추지 않습니다. **먼저 멈추는 스레드와 나중에 멈추는 스레드가 존재하며 모두 정지하고 나면 특정 동작(STW GC)을 시작**합니다. 따라서 만약 언제 멈춰야하는지를 예상할 수 있다면 훨씬 도움이 되겠죠.
- 그래서 동시 GC는 이런 GC에 필요한 작업들을 애플리케이션 스레드가 동작하는 시간동안 같이 작업해 중단 시간의 최소화를 이루는 것이 목적입니다. 하지만 CMS가 말도 많고 탈도 많다는 데에는 다 이유가 있겠죠. 이런 복잡한 프로그래밍에서 동시성을 핸들링하는 것은 쉬운 일이 아니니까요.

---